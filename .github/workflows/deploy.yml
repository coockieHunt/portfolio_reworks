name: Deploy PROD

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: VÃ©rification des secrets
        run: |
          if [ -z "${{ secrets.HOST }}" ] || [ -z "${{ secrets.USERNAME }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Secrets manquants"
            exit 1
          fi
          echo "âœ… Tous les secrets sont configurÃ©s"
      
      - name: Connexion SSH et dÃ©ploiement
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            echo "ðŸ“ Navigation vers le projet..."
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "ðŸ”„ Mise Ã  jour du code..."
            git checkout prod
            git pull origin prod
            
            echo "ðŸ“¦ Installation des dÃ©pendances..."
            npm install
            
            echo "ðŸ”¨ Build de l'application..."
            npm run build
            
            echo "ðŸ”„ RedÃ©marrage PM2..."
            pm2 reload ${{ secrets.PM2_APP_NAME }} --update-env
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"
      
      - name: Afficher le rÃ©sultat du dÃ©ploiement
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi !"
            echo "Status: SUCCESS"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement"
            echo "Status: FAILURE"
            exit 1
          fi
      
      - name: Notification de succÃ¨s
        if: success()
        run: |
          echo "ðŸŽ‰ Le dÃ©ploiement en production s'est terminÃ© avec succÃ¨s"
          echo "Branch: prod"
          echo "Commit: ${{ github.sha }}"
          echo "Auteur: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
      
      - name: Notification d'Ã©chec
        if: failure()
        run: |
          echo "âš ï¸ Le dÃ©ploiement en production a Ã©chouÃ©"
          echo "Branch: prod"
          echo "Commit: ${{ github.sha }}"
          echo "Auteur: ${{ github.actor }}"
          echo "Veuillez vÃ©rifier les logs ci-dessus"
      
      - name: RÃ©sumÃ© du dÃ©ploiement
        if: always()
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© du DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.deploy.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Heure**: $(date)" >> $GITHUB_STEP_SUMMARY